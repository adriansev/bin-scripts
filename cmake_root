#!/bin/bash

if [ ! -n "${ROOTSYS}" ]
then
  echo "ROOTSYS is not set" && exit
fi

if [[ "$2" == "release" ]]
then
  BUILDTYPE="Release"
else
  BUILDTYPE="RelWithDebInfo"
fi

## GCC version
GCCLINE=$(gcc --version|head -n1)
arr=($GCCLINE)
VER=${arr[2]}


# AVX
FQDN=`hostname -f`
if [[ "$FQDN" != "issaf.spacescience.ro"  ]] ; then
  GCCARCH="-march=native"
  avx_enable=`grep avx /proc/cpuinfo &> /dev/null && echo yes`
  [[ ${avx_enable} == "yes" ]] && AVX="-mavx"
  VC="1"
  VDT="1"
else
  ISSAF_OPT="-DVC_IMPL="SSE" -D_last_target_arch="generic" -DTARGET_ARCHITECTURE="generic" "
  GCCARCH="-march=core2"
  VC="0"
  VDT="0"
fi

CXXFLAGS="${PEDANTIC} ${GCCARCH} ${AVX}"

XRD_ALIEN="-DXROOTD_INCLUDE_DIR="${GSHELL_ROOT}/include/xrootd/" -DXROOTD_INC_PRIV_DIR="${GSHELL_ROOT}/include/xrootd/XrdClient/" \
-DXROOTD_XrdUtils_LIBRARY="${GSHELL_ROOT}/lib/libXrdUtils.so" \
-DXROOTD_XrdClient_LIBRARY="${GSHELL_ROOT}/lib/libXrdClient.so" \
-DXROOTD_XrdMain_LIBRARY="${GSHELL_ROOT}/lib/libXrdMain.so" \
"
XRD_SYS="-DXROOTD_INCLUDE_DIR="/usr/include/xrootd/" \
-DXROOTD_INC_PRIV_DIR="/usr/include/xrootd/private/XrdClient/" \
-DXROOTD_XrdUtils_LIBRARY="/usr/lib64/libXrdUtils.so" \
-DXROOTD_XrdClient_LIBRARY="/usr/lib64/libXrdClient.so" \
"

cmake \
-DCMAKE_INSTALL_PREFIX=$tools/root/root \
-Dcxx14="0" -Dcxx11="1" \
-DCMAKE_CXX_FLAGS=${CXXFLAGS} \
-DCMAKE_BUILD_TYPE=${BUILDTYPE} ${ISSAF_OPT} \
-Dbuiltin_ftgl="0" -Dbuiltin_glew="0" -Dbuiltin_gsl="0" -Dbuiltin_afterimage="0" -Dbuiltin_cfitsio="0" -Dbuiltin_davix="0" \
-Dbuiltin_freetype="0" -Dbuiltin_lzma="0" -Dbuiltin_zlib="0" -Dbuiltin_xrootd="0" -Dbuiltin_pcre="0" \
-Dvc=${VC} -Dvdt=${VDT} -Dsoversion="1" -Dgsl_shared="1" -Droofit="1" -Dminuit2="1" -Dtable="1" -Dunuran="1" -Dgdml="1" -Dqt="1" -Dqtgsi="1" \
-Dbonjour="0" -Drfio="0" -Dcastor="0" -Dglobus="0" -Dgfal="0" \
-Dpythia6_nolink="1" \
-DPYTHIA8_INCLUDE_DIR="${tools}/heplibs/pythia8/include" -DPYTHIA8_LIBRARY="${tools}/heplibs/pythia8/lib/libpythia8.so" \
-DMONALISA_INCLUDE_DIR="${tools}/heplibs/ApMon/include" -DMONALISA_LIBRARY="${tools}/heplibs/ApMon/lib/libapmoncpp.so" \
-DALIEN_INCLUDE_DIR=${GSHELL_ROOT}/include -DALIEN_LIBRARY=${GSHELL_ROOT}/lib/libgapiUI.so \
${XRD_ALIEN} \
$1


## | tee cmake_out.txt

##-DPYTHIA6_LIBRARY="${tools}/heplibs/pythia6/libPythia6.so"

